generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  CLUB_ADMIN
  SECRETARY
  COACH
  PARENT
  ATHLETE
}

enum EventType {
  TRAINING
  MATCH
  TOURNAMENT
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  JCC
  VIVA
  STRIPE
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
}

model Club {
  id          String   @id @default(cuid())
  name        String
  description String?
  logo        String?
  address     String?
  phone       String?
  email       String?
  website     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  facilities    Facility[]
  teams         Team[]
  users         User[]
  ageGroups     AgeGroup[]
  subscriptionPlans SubscriptionPlan[]
  sponsors      Sponsor[]
  announcements Announcement[]
  expenses      Expense[]

  @@map("clubs")
}

model Facility {
  id        String   @id @default(cuid())
  clubId    String
  name      String
  address   String?
  capacity  Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club   Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)
  events Event[]

  @@map("facilities")
}

model AgeGroup {
  id        String   @id @default(cuid())
  clubId    String
  name      String
  minAge    Int
  maxAge    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club  Club   @relation(fields: [clubId], references: [id], onDelete: Cascade)
  teams Team[]

  @@map("age_groups")
}

model Team {
  id         String   @id @default(cuid())
  clubId     String
  ageGroupId String?
  name       String
  sport      String?
  season     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  club      Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  ageGroup  AgeGroup? @relation(fields: [ageGroupId], references: [id], onDelete: SetNull)
  athletes  AthleteProfile[]
  coaches   CoachAssignment[]
  events    Event[]
  announcements Announcement[]

  @@map("teams")
}

model User {
  id            String   @id @default(cuid())
  clubId        String
  email         String   @unique
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          UserRole
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  club              Club               @relation(fields: [clubId], references: [id], onDelete: Cascade)
  athleteProfile    AthleteProfile?
  parentLinks       ParentLink[]
  coachAssignments  CoachAssignment[]
  deviceTokens      DeviceToken[]
  createdAnnouncements Announcement[]

  @@map("users")
}

model AthleteProfile {
  id            String   @id @default(cuid())
  userId        String   @unique
  teamId        String?
  dateOfBirth   DateTime
  emergencyContact String?
  medicalNotes  String?
  jerseyNumber  Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team          Team?    @relation(fields: [teamId], references: [id], onDelete: SetNull)
  parents       ParentLink[]
  subscriptions Subscription[]
  attendances   Attendance[]

  @@map("athlete_profiles")
}

model ParentLink {
  id         String   @id @default(cuid())
  parentId   String
  athleteId  String
  relationship String?
  createdAt  DateTime @default(now())

  parent  User           @relation(fields: [parentId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([parentId, athleteId])
  @@map("parent_links")
}

model CoachAssignment {
  id        String   @id @default(cuid())
  coachId   String
  teamId    String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  coach Coach @relation(fields: [coachId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([coachId, teamId])
  @@map("coach_assignments")
}

model Event {
  id          String    @id @default(cuid())
  teamId      String
  facilityId  String?
  type        EventType
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  team        Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)
  facility    Facility?    @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  attendances Attendance[]

  @@map("events")
}

model Attendance {
  id        String           @id @default(cuid())
  eventId   String
  athleteId String
  status    AttendanceStatus
  notes     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  event   Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  athlete AthleteProfile @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([eventId, athleteId])
  @@map("attendances")
}

model SubscriptionPlan {
  id          String   @id @default(cuid())
  clubId      String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  interval    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  club          Club           @relation(fields: [clubId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id         String             @id @default(cuid())
  athleteId  String
  planId     String
  status     SubscriptionStatus
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  athlete AthleteProfile   @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  plan    SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@map("subscriptions")
}

model Invoice {
  id             String        @id @default(cuid())
  subscriptionId String
  invoiceNumber  String        @unique
  amount         Decimal       @db.Decimal(10, 2)
  currency       String        @default("EUR")
  status         InvoiceStatus
  dueDate        DateTime
  paidAt         DateTime?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  payments     Payment[]

  @@map("invoices")
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  amount        Decimal       @db.Decimal(10, 2)
  currency      String        @default("EUR")
  method        PaymentMethod
  transactionId String?
  notes         String?
  paidAt        DateTime      @default(now())
  createdAt     DateTime      @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Expense {
  id          String   @id @default(cuid())
  clubId      String
  category    String
  description String
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  date        DateTime
  receipt     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@map("expenses")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  sku         String?  @unique
  price       Decimal  @db.Decimal(10, 2)
  currency    String   @default("EUR")
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockMovements StockMovement[]

  @@map("products")
}

model StockMovement {
  id        String   @id @default(cuid())
  productId String
  quantity  Int
  type      String
  notes     String?
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("stock_movements")
}

model Sponsor {
  id          String   @id @default(cuid())
  clubId      String
  name        String
  logo        String?
  website     String?
  contactName String?
  email       String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  club   Club          @relation(fields: [clubId], references: [id], onDelete: Cascade)
  offers SponsorOffer[]

  @@map("sponsors")
}

model SponsorOffer {
  id          String   @id @default(cuid())
  sponsorId   String
  title       String
  description String?
  discount    String?
  validFrom   DateTime
  validUntil  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sponsor Sponsor @relation(fields: [sponsorId], references: [id], onDelete: Cascade)

  @@map("sponsor_offers")
}

model Announcement {
  id        String   @id @default(cuid())
  clubId    String
  teamId    String?
  authorId  String
  title     String
  content   String
  isPinned  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  club   Club  @relation(fields: [clubId], references: [id], onDelete: Cascade)
  team   Team? @relation(fields: [teamId], references: [id], onDelete: Cascade)
  author User  @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("announcements")
}

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("device_tokens")
}
